<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>PED學習分析系統</title>

    <!-- Custom fonts for this template-->
    <link href="../6869/static/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="../6869/static/css/sb-admin-2.min.css" rel="stylesheet">

    <!-- DataTables  -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/v/dt/dt-1.10.25/datatables.min.css"/>

    <script type="text/javascript" src="https://cdn.datatables.net/v/dt/dt-1.10.25/datatables.min.js"></script>

</head>

<body id="page-top">
<div class="modal">請稍候...</div>
<!--<div style="width:100%; clear:both;"> 00</div>-->
    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Sidebar -->
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

            <!-- Sidebar - Brand -->
            <div class="sidebar-brand-icon rotate-n-15"></div>
            <div class="sidebar-brand" id="teacher_name">老師</div>
          
            <!-- Divider -->
            <hr class="sidebar-divider my-0">

            <!-- Nav Item - Dashboard --

            <!-- Divider -->
            <hr class="sidebar-divider">
            
            <!-- switch button -->
            <div class="Teacherswitch" style="width:100%; padding: 10px 0px; float: center;">
                <div class="Teacherswitch" style="margin: auto 20px;">
                    <input type="checkbox" name="Teacherswitch" class="Teacherswitch-checkbox" id="myTeacherswitch" tabindex="0">
                    <label class="Teacherswitch-label" for="myTeacherswitch" onclick="turnpage()">
                        <span class="Teacherswitch-inner"></span>
                        <span class="Teacherswitch-switch"></span>
                    </label>
                </div>
            </div>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Nav Item - Pages Collapse Menu -->
            <div class="sidebar-heading" id="sideblock_1" style="visibility: visible;">
                授課課程列表
            </div>

            <!-- Nav Item - Pages Collapse Menu -->
            <li class="nav-item"  id="sideblock_2" style="visibility: visible;">
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapsePages"
                    aria-expanded="true" aria-controls="collapsePages">
                    <i class="fas fa-fw fa-folder"></i>
                    <span>113第一學期</span>
                </a>
                <div id="collapsePages" class="collapse" aria-labelledby="headingPages" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded" id='divCourseContainer_1131'>
                        <a class="collapse-item" href="charts.html">課程列表:</a>
                    </div>
                </div>

                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapsePages"
                    aria-expanded="true" aria-controls="collapsePages">
                    <i class="fas fa-fw fa-folder"></i>
                    <span>112第二學期</span>
                </a>
                <div id="collapsePages" class="collapse" aria-labelledby="headingPages" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded" id='divCourseContainer_1122'>
                        <a class="collapse-item" href="charts.html">課程列表:</a>
                    </div>
                </div>

                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapsePages"
                    aria-expanded="true" aria-controls="collapsePages">
                    <i class="fas fa-fw fa-folder"></i>
                    <span>112第一學期</span>
                </a>
                <div id="collapsePages" class="collapse" aria-labelledby="headingPages" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded" id='divCourseContainer_1121'>
                        <a class="collapse-item" href="charts.html">課程列表:</a>
                    </div>
                </div>
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapsePages"
                    aria-expanded="true" aria-controls="collapsePages">
                    <i class="fas fa-fw fa-folder"></i>
                    <span>111第二學期</span>
                </a>
                <div id="collapsePages" class="collapse" aria-labelledby="headingPages" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded" id='divCourseContainer_1112'>
                        <a class="collapse-item" href="charts.html">課程列表:</a>
                    </div>
                </div>            
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapsePages"
                    aria-expanded="true" aria-controls="collapsePages">
                    <i class="fas fa-fw fa-folder"></i>
                    <span>111第一學期</span>
                </a>
                <div id="collapsePages" class="collapse" aria-labelledby="headingPages" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded" id='divCourseContainer_1111'>
                        <a class="collapse-item" href="charts.html">課程列表:</a>
                    </div>
                </div>
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapsePages"
                    aria-expanded="true" aria-controls="collapsePages">
                    <i class="fas fa-fw fa-folder"></i>
                    <span>110第二學期</span>
                </a>
                <div id="collapsePages" class="collapse" aria-labelledby="headingPages" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded" id='divCourseContainer_1101'>
                        <a class="collapse-item" href="charts.html">課程列表:</a>
                    </div>
                </div>
                <a class="nav-link collapsed" href="#" data-toggle="collapse" data-target="#collapsePages"
                    aria-expanded="true" aria-controls="collapsePages">
                    <i class="fas fa-fw fa-folder"></i>
                    <span>110第一學期</span>
                </a>
                <div id="collapsePages" class="collapse" aria-labelledby="headingPages" data-parent="#accordionSidebar">
                    <div class="bg-white py-2 collapse-inner rounded" id='divCourseContainer_1101'>
                        <a class="collapse-item" href="charts.html">課程列表:</a>
                    </div>
                </div>
            </li>
            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Sidebar Toggler (Sidebar) -->
            <div class="text-center d-none d-md-inline">
                <button class="rounded-circle border-0" id="sidebarToggle"></button>
            </div>

        </ul>
        <!-- End of Sidebar -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- Main Content -->
            <div id="content">

                <!-- Topbar -->
                <nav class="navbar navbar-light bg-white topbar mb-4 static-top shadow">
                    <div class="col-lg-12" style="float:left;padding: auto; height:150px;">
                        <div class=" col-lg-9" style="float:left;">
                            <img src="static/img/logoPEDsystem.png" width="350" height="85" alt="學習成效及參與評估系統">
                        </div>
                        <div class="col-lg-9" style="float:right; width:25%">
                            <ul id="pageBtnS">
                                <li><a href="javascript:history.back()" title="回到系統首頁">Home</a></li>
                                <li><a type="button" class="popupbtn" onclick='showModal1()' title="使用說明">Help</a></li>
                                <li><a onclick='storge_course_id()' href="P_mods" target="_blank" title="查看各區學生名單">學生分區</a></li>
                                <li><a href="https://forms.office.com/r/pm8fxkz9uG" target="_blank" rel="noreferrer noopenner" title="申請遠距教學中心專人服務">服務申請</a></li>
                                <!--<li><a href="http://web.tku.edu.tw/iclassdashboard" target="_blank">iClass儀表板</a></li>-->
                            </ul>
                        </div>
                    </div>
                </nav>
                <!-- End of Topbar -->
                    
            </div>

            <!-- Begin Page Content -->
            <div class="container-fluid"  id="infoblock_1" style="display: ;">

                <!-- Page Heading -->
                <h1 class="h4 mb-2 text-gray-800 pa-left" id='label_course_name'>課程名稱</h1>
                <p class="mb-4 pa-left" id='label_course_class'></p>
                <p class="mb-4 pa-left" id='label_course_enrolled'></p>                    

                <!-- Content Row -->
                <div class="row">
                    <div class="col-xl-8 col-lg-7">

                        <!-- Area Chart -->
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">全班所有同學最近一週之學習表現及參與</h6>
                                <div style="display: flex; align-items: center;">
                                    目前週次:
                                    <h3 id="week" style="font-size: 2em;"></h3>
                                    <select id="selectWeek" onchange='set_week()' style="border-radius: 5px; font-size: 1em;"></select>
                                    <input id="week_last" type="button" value="<<上一週" onclick="last_week()" style="border-radius: 5px; font-size: 1em;">
                                    <input id="week_next" type="button" value="次一週>>" onclick="next_week()" style="border-radius: 5px; font-size: 1em;">
                                    <label>
                                        <input type="checkbox" class="filterCheckbox" id="PEfilterP1" > M1
                                    </label>
                                    <label>
                                        <input type="checkbox" class="filterCheckbox" id="PEfilterP2" > M2
                                    </label>
                                    <label>
                                        <input type="checkbox"  id="PEfilterP3"> M3
                                    </label>
                                </div>
                                <div id='container-pe-course'></div>
                                資料更新日期：113上學年第六周 <p>點選上方資料點後，可觀察個別學生表現
                            </div>
                        </div>

                        <!-- Line Chart -->
                        <div class="card shadow mb-4">
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">學生逐週學習表現及參與</h6>
                            </div>
                            <div class="card-body">
                                <p class="highcharts-description"></p>
                                <div class="chart-bar" id='container-pe-student'></div>
                                <hr>
                                選擇觀看個別修課學生表現:
                                <select id="ddlStudents" onchange='onSelect_student()'></select>
                                </br>performance: 作業、測驗、問卷、點名及討論累計分數相較全班之表現, 
                                </br>engagement: 點名、作業及測驗繳交累計次數相較全班之表現
                                <br>
                                <a hidden onclick="storge_course_id()" style="width: 50%; margin: auto; color:blue;" href="charts_detail" target="_blank">查看全體同學學期各週表現</a>
                            </div>
                        </div>
                    </div>

                    <!-- Donut Chart -->
                    <div class="col-xl-4 col-lg-5">
                        <div class="card shadow mb-4">
                            <!-- Card Header - Dropdown -->
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">各類表現學生分布</h6>
                                <div id="divSemiCirclePieChart"></canvas></div>
                            </div>

                            <!-- Card Body -->
                            <div class="card-body">老師可適時對綠區(I)中表現優良學生加以表揚，<br>對黃區(II, IV)及紅區 (III)學生加以關懷及輔導。<hr>
                                <div class="chart-pie pt-1">
                                    <div class="row" style="padding-top:5%;">
                                        <div class="col-lg-6 mb-4">
                                            <div class="card bg-warning text-white shadow">
                                                <div class="card-body" id="quadrant_o" style="text-align:center;">第 II 象限
                                                    <br><span class="text-white small">高參與 + 低成效</span>
                                                    <div class="text-black-50 small nlist" id='label_student_list_II' >名單</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6 mb-4">
                                            <div class="card bg-success text-white shadow">
                                                <div class="card-body" id="quadrant_g" style="text-align:center;">第 I 象限
                                                    <br><span class="text-white small">前5%表現優良學生名單</span>
                                                    <div class="text-black-50 small nlist" id='label_student_list_I' ></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6 mb-4">
                                            <div class="card bg-danger text-white shadow">
                                                <div class="card-body" id="quadrant_r" style="text-align:center;">第 III 象限<br>
                                                    <span class="text-white small">低參與 + 低成效</span>
                                                    <div class="text-black-50 small nlist"  id='label_student_list_III'>名單</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6 mb-4">
                                            <div class="card bg-warning2 text-white shadow "style="background-color: #FADB14">
                                                <div class="card-body" id="quadrant_y" style="text-align:center;">第 IV 象限<br>
                                                    <span class="text-white small">低參與 + 高成效</span>                                        
                                                    <div class="text-black-50 small nlist" id='label_student_list_IV'>名單</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <!-- end of card body -->
                            </div>

                        </div>

                    <!-- end of dount chart -->
                    </div>
                </div>
            </div>
            <!-- /.container-fluid -->
            
            <!-- Advisor Edition -->
            <div class="container-fluid"  id="infoblock_2" style="display: none;">
                <h1 class="h4 mb-2 text-gray-800 " id='label_course_name'>本學期學生學習表現：
                    <button id="resetFilter" style="border-radius: 5px; font-size: 1em;">reset</button>
                    <label><input type="checkbox" id="filterP1"> M1(出席率未達4成)</label>
                    <label><input type="checkbox" id="filterP2"> M2(低參與、低成效)</label>
                    <label hidden><input type="checkbox" id="filterP3" > M3</label>
                </h1>
                <div id="explanation" ></div>
                <br>
                <a>圖示表示學生表現位於何區 :<a>
                <br> 
                <img src="../6869/static/img/green.png" width="16" height="16" style="margin-left: 20px">綠區(第一象限)
                <img src="../6869/static/img/yellow.png" width="16" height="16" style="margin-left: 20px">黃區(第四象限)
                <img src="../6869/static/img/orange.png" width="16" height="16" style="margin-left: 20px">橘區(第二象限)
                <img src="../6869/static/img/red.png" width="16" height="16" style="margin-left: 20px">紅區(第三象限)             
                
                <!-- Content Row -->
                
                <div class="row">
                    <div class="col-xl-8 col-lg-7">

                        <div class="card shadow mb-4" style="max-height: 600px; overflow-y: auto; margin-bottom: 40px;">
                            <table id="tbl_course_list" height="600" >
                              <colgroup span="4"></colgroup>
                              <tr>
                                <th>學生學號</th>
                                <th>學生姓名<input type="text" id="name-search" placeholder="搜索學生姓名..."></th>
                                <th>學生身份</th>
                                <th>學習表現</th>
                              </tr>
                            </table>
                        </div>

                        <div id="info-display" style="font-size: 22px; line-height: 1.8; margin: 20px 0; color: #333;"></div>       
                        <!-- Area Chart -->
                        <div class="card shadow mb-4">
                            <table id="tbl_student_course_list" height="600">
                              <colgroup span="5"></colgroup>
                              <tr>
                                <th>課程名稱</th>
                                <th>課程代碼</th>
                                <th>警示燈號</th>
                                <th>學習表現</th>
                                <th>參與度</th>
                               
                              </tr>
                            </table>
                        </div>


                        <div class="card shadow mb-4">
                            <ul class="tabs_pe" style="height: 50px; list-style: none; padding: 0; margin: 20px 0 0 0; display: flex;">
                                <li class="active" style="width: 35%; height: 50px;">
                                    <a href="#tab01" class="tab-link" style="display:inline-block;width: 100%;height:80%;line-height: 40px;text-align: center;margin: 0; border-radius: 25px; border: 2px solid #ccc; position: relative;">你的表現與分布圖</a>
                                </li>
                                <li style="width: 35%; height: 50px;">
                                    <a href="#tab02" class="tab-link" style="display:inline-block;width: 100%;height:80%;line-height: 40px;text-align: center;margin: 0; border-radius: 25px; border: 2px solid #ccc; position: relative;">你的表現與班平均比較</a>
                                </li>
                            </ul>
                        
                            <div id="tab01" class="tab-inner" style="display: block;">
                                <h6 class="m-0 font-weight-bold text-primary"><span id="dynamicStudnetNumber"></span><span id="dynamicStudnetName"></span> 於本課程中相對於所有修課同學的表現(紅點)</h6>
                                <div id="container-pe-course-student"></div>
                            </div>
                            <div id="tab02" class="tab-inner" style="display: none;">
                                <h6 class="m-0 font-weight-bold text-primary"><span id="dynamicStudnetNumber1"></span><span id="dynamicStudnetName1"></span> 每周的表現與班平均</h6>
                                <div id="container-pe-avg"></div>
                            </div>

                        </div>
                        performance: 作業、測驗、問卷、點名及討論累計分數相較全班之表現, 
                        </br> engagement: 點名、作業及測驗繳交累計次數相較全班之表現
                        
                    </div>

                    <div class="col-xl-4 col-lg-5">
                        <div class="card shadow mb-4">
                            <!-- Card Header - Dropdown -->
                            <div class="card-header py-3">
                                <h6 class="m-0 font-weight-bold text-primary">
                                    <span id="dynamicStudnetNumber2"></span><span id="dynamicStudnetName2"></span> 本學期所修課程警示燈號分佈概況
                                </h6>
                              <div id="divSemiCirclePieChart-student"></canvas>
                              </div>
                            </div>
                            <p>資料更新:113上學年第六周 <p>
                        </div>

                    </div>
                </div>
                
            </div>
            <!-- End of Advisor Edition -->

            <!-- Footer -->
            <footer class="sticky-footer bg-white">
                <div class="container my-auto">
                    <div class="copyright text-center my-auto">
                        <span>Copyright &copy; 淡江大學　資訊處遠距教學發展中心    系統更新:2024.10.22</span>
                    </div>
                </div>
            </footer>
            <!-- End of Footer -->

        </div>
        <!-- End of Content Wrapper -->

    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>

    <!-- Logout Modal-->
    <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                    <a class="btn btn-primary" href="/login.html">Logout</a>
                </div>
            </div>
        </div>
    </div>
    <!-- Pop-up page -->
    <div class="pop-up-container" style="display: none;">
        <div class="pop-up-container-root">
            <div class="pop-up-box">
                <div class="pop-up-title">
                    <h4>PED (Performance & Engagement Diagram) 學習分析系統簡介</h4>
                    <span class="pop-up-close" onclick="closeModal1()">&times;</span>
                </div>
                <div class="pop-up-content">
                    <p>
                        PED系統是iSignal學習預警機制的一環，是以授課教師為服務對象所開發的系統，
                        可以呈現每門課程中的整體及個別學生的學習表現。系統透過蒐集、分析iClass平台上大量的學習活動數據後，
                        將數據max-min數值正規化後等比例縮放到0~1的區間中，並以視覺化儀表板呈現。 
                    </p>
                    <p>
                        PED數據取自iClass平台，記錄學生每門課程的參與情況（例如：出席、繳交作業、
                        參與測驗、參與討論...等）以及學習成績，是非常客觀的學習證據。只要授課教師在iClass平台上，逐週點名、發布6次以上之教學活動、設定成績比例，並儘早批改給予成績，透過PED系統逐週的計算與轉置，教師便能掌握累計至前一週之全班同學的成績和參與度，從而及時給予優秀學生表揚與學習落後者輔導。系統簡介如下：
                    </p>
                    <p>1.登入系統後，畫面左側有授課課程列表，可切換觀看。</p>
                    <img src="static/img/PED_png/PED_interface.png" alt="PED首頁">
                    <p>2.畫面中間上方呈現全班學生整體的修課表現，每個學期的PED資料皆於第4週起呈現於系統上（原因：開學前3週資料量少、加退選…等）。 </p>
                    <img src="static/img/PED_png/PED_xychart.png" alt="PED圖表">
                    <p>3.X軸為學習成效（Performance），採計作業、測驗、問卷、點名及討論…等，累計<a class="r">分數</a>；Y軸為參與度（Engagement），採計點名、作業及測驗繳交…等，累計<a class="r">次數</a>。</p>
                    <p>4.平面座標上，以X軸及Y軸劃分為4個象限，以色點呈現學生課業表現分布情形，每個點代表一位學生。象限說明： </p>
                    <p>&emsp;第I象限<a class="g">綠</a>區：<a class="g">綠</a>點代表表現正常之學生；<a class="b">藍</a>點代表前5%表現最優的學生，其學習參與及學習活動成績表現都足為表率，值得嘉許，可適時表揚，或作為學生助教、小老師的人選參考。 </p>
                    <p>&emsp;第II象限<a class="y">黃</a>區：學習參與度高但成績表現不如預期，需要師長進一步了解其學習瓶頸，加以輔導。 </p>
                    <p>&emsp;第III象限<a class="r">紅</a>區：代表學習參與及成績表現均不佳，也許除課業問題外尚需其他生活輔導，可能需要其他師長介入共同輔導（如：導師、教官、諮輔專業人員）。 </p>
                    <p>&emsp;第IV象限<a class="y">黃</a>區：代表學生可能已了解授課內容，以致參與度差但成績表現尚可，教師可以規劃並鼓勵學生研習進階課程。 </p>
                    <p>5.畫面右側為各區分佈情況，游標靠近時會呈現該區之人數及比例 </p>
                    <img src="../6869/static/img/PED_png/PED_piechart1.png" alt="PED扇形圖">
                    <img src="../6869/static/img/PED_png/PED_piechart2.png" alt="PED扇形圖2">
                    <p>6.畫面中間下方呈現個別學生表現（教師可從全班的PED上，或從下拉選單中點選學生），以折線圖觀察指定學生逐週之學習成效（藍線）和參與度（黑線）。 </p>
                    <img src="../6869/static/img/PED_png/PED_linechart.png" alt="PED折線圖">
                    <p>7.畫面右下方呈現學生名單：第II、III、IV象限皆為該區之名單，唯綠區所呈現為前5%表現最優的學生（<a class="b">藍點</a>）。 </p>
                    <img src="../6869/static/img/PED_png/PED_stu_classify.png" alt="PED學生分類">
                    <p>8.<a class="r">授課教師</a>可從PED的4個象限中，精準地發現學習落後或是參與情況不佳的學生，以便適時進行課業輔導、勉勵學習，或是調整教學策略與節奏。</p>
                    <p>9.PED所呈現之每位學生各科的燈號已匯入SIS（導師輔導系統），使<a class="r">班導師</a>能了解導生每週的學習成效與學習態度，掌握需要關懷的對象，並得以適時介入輔導，以提升學生的留校率與畢業率。 </p>
                </div>

                <div class="pop-up-action">
                    <button class="close-btn" onclick='closeModal1()'>關閉</button>
                </div>

            </div>
        </div>
    </div>
    
    <!-- Pop-up page JavaScritp -->
    <script>
        function showModal1(){

            const modalWrap =  document.querySelector('.pop-up-container');
            
            const popup =  modalWrap.querySelector('.pop-up-box');
            
            modalWrap.style.display = 'flex';
            popup.style.transform = 'scale(0)';
            
            setTimeout(()=>  popup.style.transform = 'scale(1)',0)
        }

        function closeModal1(){
            
            const modalWrap =  document.querySelector('.pop-up-container');
            
            const popup =  modalWrap.querySelector('.pop-up-box');
            
            popup.style.transform = 'scale(0)';
            
            setTimeout(()=> modalWrap.style.display = 'none',300)
        }
    </script>

    <!-- Bootstrap core JavaScript-->
    <script src="../6869/static/vendor/jquery/jquery.min.js"></script>
    <script src="../6869/static/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="../6869/static/vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="../6869/static/js/sb-admin-2.min.js"></script>

    <!-- Page level plugins -->
    <script src="../6869/static/vendor/chart.js/Chart.min.js"></script>

    <!-- Page level custom scripts -->
    <script src="../6869/static/js/demo/chart-area-demo.js"></script>
    <script src="../6869/static/js/demo/chart-pie-demo.js"></script>
    <script src="../6869/static/js/demo/chart-bar-demo.js"></script>

</body>
<style>
/* Start by setting display:none to make this hidden.
   Then we position it in relation to the viewport window
   with position:fixed. Width, height, top and left speak
   for themselves. Background we set to 80% white with
   our animation centered, and no-repeating */
.modal {
    display:    none;
    position:   fixed;
    z-index:    1000;
    top:        0;
    left:       0;
    height:     100%;
    width:      100%;
    background: rgba( 255, 255, 255, .8 ) 
                url('http://i.stack.imgur.com/FhHRx.gif') 
                50% 50% 
                no-repeat;
}

/* When the body has the loading class, we turn
   the scrollbar off with overflow:hidden */
body.loading .modal {
    overflow: hidden;   
}

/* Anytime the body has the loading class, our
   modal element will be visible */
body.loading .modal {
    display: block;
}

#divSemiCirclePieChart {
    height: 400px;
}

.highcharts-data-table table {
    font-family: Verdana, sans-serif;
    border-collapse: collapse;
    border: 1px solid #ebebeb;
    margin: 10px auto;
    text-align: center;
    width: 100%;
    max-width: 500px;
}

.highcharts-data-table caption {
    padding: 1em 0;
    font-size: 1.2em;
    color: #555;
}

.highcharts-data-table tr:hover {
    background: #f1f7ff;
}
</style>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://code.highcharts.com/modules/exporting.js"></script>
<script src="https://code.highcharts.com/modules/accessibility.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script>
//__local_API_ADDR='http://20.212.230.118:7071/';
//__local_API_ADDR='https://bida.ipc.tku.edu.tw/pedev/7071/';
__local_API_ADDR='https://sso.tku.edu.tw/oisbida/pedev/7071/';
pe_series = [];
course_name = '';

//setweek
_currentWeek = 9;
_currentCategories = [];
for (let i = 1; i <= _currentWeek; i++) {
    _currentCategories.push(i);
}
_traverseWeek=_currentWeek;
_semester = 1131

p_thres=e_thres=0.6;
_last_pt_color='';

var scatter_color = {
    "0": 'rgba(97, 172, 214, .5)',
    "+1": 'rgba(126, 216, 147, .5)',
    "+2": 'rgba(42, 176, 73, .5)',
    "-1": 'rgba(231, 131, 133, .5)',
    "-2": 'rgba(176, 42, 44, .5)',
}

course_data = []

$body = $("body");

$(document).on({
    ajaxStart: function() { $body.addClass("loading");    },
     ajaxStop: function() { $body.removeClass("loading"); }    
});

$(document).ready(function(){ 
    input_teacherId();
    
});

function set_week(){
   w = document.getElementById('selectWeek').value;
   document.getElementById('week').textContent = w;
   _traverseWeek = parseInt(w);
   redraw_scatterplot(window.course_id, window.semester, _traverseWeek);
}

function last_week(){
    if (_traverseWeek <= 1)
        _traverseWeek = 1;
    else
        _traverseWeek -= 1;
        
    
    //alert("traverse week:" + _traverseWeek + ", course id:" + window.course_id + ", semester:" + window.semester);
    document.getElementById('week').textContent = _traverseWeek;
    document.getElementById('selectWeek').value = _traverseWeek;
    
    redraw_scatterplot(window.course_id, window.semester, _traverseWeek);
}

function next_week(){

    if (window.semester == _semester && _traverseWeek >= _currentWeek)
        return;
    else if (window.semester != _semester && _traverseWeek >= _maxWeek)
        return;
    else
        _traverseWeek += 1       
    
    //alert("traverse week:" + _traverseWeek + ", course id:" + window.course_id + ", semester:" + window.semester);
    document.getElementById('week').textContent = _traverseWeek;
    document.getElementById('selectWeek').value = _traverseWeek;
    
    redraw_scatterplot(window.course_id, window.semester, _traverseWeek);
}

function onSelect_student(){

   //alert(window.course_id);
   //alert($("#ddlStudents option:selected").text());
   draw_student_pe( window.course_id, $("#ddlStudents").val(), $("#ddlStudents option:selected").text());
}

function input_teacherId(){
    
    const tid = window.localStorage.getItem("teacher_id") || [];
    
    url_text = __local_API_ADDR + 'get_student_name?student_id='+tid//get teacher name
    $.ajax({
        url : url_text,
        type : "GET",
        success : function(data) {
            document.getElementById('teacher_name').textContent = data.student_name + "老師";
        }
    });
    
    t_id = tid.toString();
    if (t_id.length==5){
        t_id = '0' + t_id;
    }
    if (t_id.length==4){
        t_id = '00' + t_id;
    }
    if (t_id.length==3){
        t_id = '000' + t_id;
    }
    //alert(t_id);
    
    // 1. call API to retrieve course info
    // 2. list all course by checkbox
    // 3. display all course's activity count
    
    __1st_course_id='';
    
    url_text = __local_API_ADDR + "get_course_list_by_teacherid?semester="+_semester+"&teacher_id="+t_id
    $.ajax({
        url: url_text,
        type: "GET"
    }).error( function(request, error) {
        alert("Error: responseText: " + request.responseText);    
    }).success( function(getCourseData) {
    
        if (getCourseData == JSON.stringify({})) {
            alert("您這學期並未於iClass平台上擔任其中一門課程的授課教師！");
            $body.removeClass("loading");
            //location.href = "index";
            return;
        }
        
        course_list = JSON.parse(getCourseData);
        //window.alert(course_list.length)
        
        if (course_list.length!=0){
    
            var container = $('#divCourseContainer_1131');
            container.empty();
            
            // set id as course_code
            for (let cl of course_list) {
                let txtCaption = "";
                let course_code = cl.course_code;
                let course_name = cl.course_name;
                let course_id = cl.course_id;
                let enroll_student_cnt = cl.enroll_student_cnt;            
    
                if (__1st_course_id.length==0){
                    __1st_course_id = course_id;
                }
    
                var br = document.createElement('br');
    
                var a = document.createElement('a');
                var linkText = document.createTextNode(course_name + course_code.substring(11) );
                a.appendChild(linkText);
                a.title = course_name + course_code.substring(11) ;
                //a.href = "charts.html?semester=" + semester + "&cid=" +  course_id;
                a.href="javascript:redraw_chart(" + course_id + ","+_semester+")";
                
                container.append(a);
                
                container.append(br);            
            }     
            
                    
            if (__1st_course_id.length!=0){
                setTimeout( function() { redraw_chart(__1st_course_id, _semester); }, 100);
            }
        }
    });
    
    semester = '1101';
    
    url_text = __local_API_ADDR + "get_course_list_by_teacherid?semester=1101&teacher_id="+t_id
    //alert(url_text);
    
    $.ajax({
        url: url_text,
        type: "GET"
    }).error( function(request, error) {
        alert("Error: responseText: " + request.responseText);    
    }).success( function(getCourseData) {
    
        if (getCourseData == JSON.stringify({})) {
            return;
        }
        
        course_list = JSON.parse(getCourseData);
        //window.alert(course_list.length)
        
        if (course_list.length!=0){
    
            var container = $('#divCourseContainer_1101');
            container.empty();
            
            // set id as course_code
            for (let cl of course_list) {
                let txtCaption = "";
                let course_code = cl.course_code;
                let course_name = cl.course_name;
                let course_id = cl.course_id;
                let enroll_student_cnt = cl.enroll_student_cnt;            
    
                var br = document.createElement('br');
    
                var a = document.createElement('a');
                var linkText = document.createTextNode(course_name + course_code.substring(11) );
                a.appendChild(linkText);
                a.title = course_name + course_code.substring(11) ;
                //a.href = "charts.html?semester=" + semester + "&cid=" +  course_id;
                a.href="javascript:redraw_chart(" + course_id + ",1101)";
                 
                container.append(a);
                
                container.append(br);            
            }     
        }
    });    
    
    semester = '1102';
    
    url_text = __local_API_ADDR + "get_course_list_by_teacherid?semester=1102&teacher_id="+t_id
    //alert(url_text);
    
    $.ajax({
        url: url_text,
        type: "GET"
    }).error( function(request, error) {
        alert("Error: responseText: " + request.responseText);    
    }).success( function(getCourseData) {
    
        if (getCourseData == JSON.stringify({})) {
            return;
        }
        
        course_list = JSON.parse(getCourseData);
        //window.alert(course_list.length)
        
        if (course_list.length!=0){
    
            var container = $('#divCourseContainer_1102');
            container.empty();
            
            // set id as course_code
            for (let cl of course_list) {
                let txtCaption = "";
                let course_code = cl.course_code;
                let course_name = cl.course_name;
                let course_id = cl.course_id;
                let enroll_student_cnt = cl.enroll_student_cnt;            
    
                var br = document.createElement('br');
    
                var a = document.createElement('a');
                var linkText = document.createTextNode(course_name + course_code.substring(11) );
                a.appendChild(linkText);
                a.title = course_name + course_code.substring(11) ;
                //a.href = "charts.html?semester=" + semester + "&cid=" +  course_id;
                a.href="javascript:redraw_chart(" + course_id + ",1102)";
                 
                container.append(a);
                
                container.append(br);            
            }     
        }
    });
    
    semester = '1111';
    
    url_text = __local_API_ADDR + "get_course_list_by_teacherid?semester=1111&teacher_id="+t_id
    //alert(url_text);
    
    $.ajax({
        url: url_text,
        type: "GET"
    }).error( function(request, error) {
        alert("Error: responseText: " + request.responseText);    
    }).success( function(getCourseData) {
    
        if (getCourseData == JSON.stringify({})) {
            return;
        }
        
        course_list = JSON.parse(getCourseData);
        //window.alert(course_list.length)
        
        if (course_list.length!=0){
    
            var container = $('#divCourseContainer_1111');
            container.empty();
            
            // set id as course_code
            for (let cl of course_list) {
                let txtCaption = "";
                let course_code = cl.course_code;
                let course_name = cl.course_name;
                let course_id = cl.course_id;
                let enroll_student_cnt = cl.enroll_student_cnt;            
    
                var br = document.createElement('br');
    
                var a = document.createElement('a');
                var linkText = document.createTextNode(course_name + course_code.substring(11) );
                a.appendChild(linkText);
                a.title = course_name + course_code.substring(11) ;
                //a.href = "charts.html?semester=" + semester + "&cid=" +  course_id;
                a.href="javascript:redraw_chart(" + course_id + ",1111)";
                 
                container.append(a);
                
                container.append(br);            
            }
        }
    });
    semester = '1112';
    
    url_text = __local_API_ADDR + "get_course_list_by_teacherid?semester=1112&teacher_id="+t_id
    //alert(url_text);
    
    $.ajax({
        url: url_text,
        type: "GET"
    }).error( function(request, error) {
        alert("Error: responseText: " + request.responseText);    
    }).success( function(getCourseData) {
    
        if (getCourseData == JSON.stringify({})) {
            return;
        }
        
        course_list = JSON.parse(getCourseData);
        //window.alert(course_list.length)
        
        if (course_list.length!=0){
    
            var container = $('#divCourseContainer_1112');
            container.empty();
            
            // set id as course_code
            for (let cl of course_list) {
                let txtCaption = "";
                let course_code = cl.course_code;
                let course_name = cl.course_name;
                let course_id = cl.course_id;
                let enroll_student_cnt = cl.enroll_student_cnt;            
    
                var br = document.createElement('br');
    
                var a = document.createElement('a');
                var linkText = document.createTextNode(course_name + course_code.substring(11) );
                a.appendChild(linkText);
                a.title = course_name + course_code.substring(11) ;
                //a.href = "charts.html?semester=" + semester + "&cid=" +  course_id;
                a.href="javascript:redraw_chart(" + course_id + ",1112)";
                 
                container.append(a);
                
                container.append(br);            
            }
        }
    });
    
    semester = '1121';
    
    url_text = __local_API_ADDR + "get_course_list_by_teacherid?semester=1121&teacher_id="+t_id
    
    $.ajax({
        url: url_text,
        type: "GET"
    }).error( function(request, error) {  
    }).success( function(getCourseData) {
    
        if (getCourseData == JSON.stringify({})) {
            return;
        }
        
        course_list = JSON.parse(getCourseData);
        //window.alert(course_list.length)
        
        if (course_list.length!=0){
    
            var container = $('#divCourseContainer_1121');
            container.empty();
            
            // set id as course_code
            for (let cl of course_list) {
                let txtCaption = "";
                let course_code = cl.course_code;
                let course_name = cl.course_name;
                let course_id = cl.course_id;
                let enroll_student_cnt = cl.enroll_student_cnt;            
    
                var br = document.createElement('br');
                var a = document.createElement('a');
                var linkText = document.createTextNode(course_name + course_code.substring(11) );
                a.appendChild(linkText);
                a.title = course_name + course_code.substring(11) ;
                //a.href = "charts.html?semester=" + semester + "&cid=" +  course_id;
                a.href="javascript:redraw_chart(" + course_id + ",1121)";
                 
                container.append(a);
                container.append(br);            
            }
        }
    });
    semester = '1122';
    
    url_text = __local_API_ADDR + "get_course_list_by_teacherid?semester=1122&teacher_id="+t_id
    //alert(url_text);
    
    $.ajax({
        url: url_text,
        type: "GET"
    }).error( function(request, error) {
        alert("Error: responseText: " + request.responseText);    
    }).success( function(getCourseData) {
    
        if (getCourseData == JSON.stringify({})) {
            return;
        }
        
        course_list = JSON.parse(getCourseData);
        //window.alert(course_list.length)
        
        if (course_list.length!=0){
    
            var container = $('#divCourseContainer_1122');
            container.empty();
            
            // set id as course_code
            for (let cl of course_list) {
                let txtCaption = "";
                let course_code = cl.course_code;
                let course_name = cl.course_name;
                let course_id = cl.course_id;
                let enroll_student_cnt = cl.enroll_student_cnt;            
    
                var br = document.createElement('br');
    
                var a = document.createElement('a');
                var linkText = document.createTextNode(course_name + course_code.substring(11) );
                a.appendChild(linkText);
                a.title = course_name + course_code.substring(11) ;
                //a.href = "charts.html?semester=" + semester + "&cid=" +  course_id;
                a.href="javascript:redraw_chart(" + course_id + ",1122)";
                 
                container.append(a);
                
                container.append(br);            
            }     
        }
    });    
}
class PEF {
    static filterP1 = false;
    static filterP2 = false;
    static filterP3 = false;
}

$('#PEfilterP1').on('click', function() {
    PEF.filterP1 = !PEF.filterP1;
    redraw_chart(window.course_id, window.semester , _traverseWeek);
    
});
$('#PEfilterP2').on('click', function() {
    PEF.filterP2 = !PEF.filterP2;
    redraw_chart(window.course_id, window.semester , _traverseWeek);
});
$('#PEfilterP3').on('click', function() {
    PEF.filterP3 = !PEF.filterP3;
    redraw_chart(window.course_id, window.semester , _traverseWeek);
});
function redraw_chart(course_id, semester, traverseWeek) {

    var fetchdata_json = new Array();
    
    window.course_id = course_id;
    window.semester = semester;
    
    if (semester==_semester) {
        _week=_currentWeek
    }
    else {
        _week=18
    }
    
    document.getElementById('week').textContent = _week;
    _traverseWeek = _week;
    
    document.getElementById('selectWeek').innerText = null;
    document.getElementById('selectWeek').value =_week;
    
    let weeks = document.getElementById('selectWeek');
    for(let g=_week; g>0; g--) {
        let option = document.createElement('option');
        option.value = g;
        option.text = g;
        weeks.appendChild(option);
    }
    $.ajax({    
        url: __local_API_ADDR + "get_pe_data?course_id="+course_id+"&week="+(_week),
        type: "GET"
    }).success( function(getData) {
        course_name = '';
        week_list = JSON.parse(getData);
        document.getElementById('label_student_list_I').textContent = ""; 
        document.getElementById('label_student_list_II').textContent = ""; 
        document.getElementById('label_student_list_III').textContent = ""; 
        document.getElementById('label_student_list_IV').textContent = "";        
        
        $("#ddlStudents").empty();
        
        for (let el of week_list) {
            week = el.week;
            course_name = el.course_name;
            course_code = el.course_code;
            let filteredDataList = [];

            //console.log(course_code)
            
            caption_text = ""

            if (week==_week) {
                pe_series = [];                                
                
                for(d of el.data_list) {
                    d.color = scatter_color[d.color_type];
                    $("#ddlStudents").append('<option value="' + d.user_code + '">' + d.name + '</option>');

                    // Existing quadrant logic...
                    if (d.x >= 0.6 && d.y >= 0.6) {
                        if (d.x >= 0.95 && d.y >= 0.95) {
                            document.getElementById('label_student_list_I').textContent += "  " + d.name;
                            d.color = '#0040FF';
                        } else {
                            d.color = '#9FE6A0';
                        }
                    } else if (d.x < 0.6 && d.y >= 0.6) {
                        document.getElementById('label_student_list_II').textContent += "  " + d.name;
                        d.color = '#FD8C04';
                    } else if (d.x < 0.6 && d.y < 0.6) {
                        document.getElementById('label_student_list_III').textContent += "  " + d.name;
                        d.color = '#E60965';
                    } else {
                        document.getElementById('label_student_list_IV').textContent += "  " + d.name;
                        d.color = '#FFFF37';
                    }
                    if (PEF.filterP1 && !PEF.filterP2 && !PEF.filterP3) {
    // 只有 P1 被選中，篩選 p1 > 0 的數據
                        if (d.p1 > 0) {
                            filteredDataList.push(d); 
                        }
                    } else if (!PEF.filterP1 && PEF.filterP2 && !PEF.filterP3) {
                        // 只有 P2 被選中，篩選 p2 > 0 的數據
                        if (d.p2 > 0) {
                            filteredDataList.push(d); 
                        }
                    } else if (!PEF.filterP1 && !PEF.filterP2 && PEF.filterP3) {
                        // 只有 P3 被選中，篩選 p3 > 0 的數據
                        if (d.p3 > 0) {
                            filteredDataList.push(d); 
                        }
                    } else if (PEF.filterP1 && PEF.filterP2 && !PEF.filterP3) {
                        // P1 和 P2 被選中，篩選 p1 > 0 或 p2 > 0 的數據
                        if (d.p1 > 0 || d.p2 > 0) {
                            filteredDataList.push(d); 
                        }
                    } else if (PEF.filterP1 && !PEF.filterP2 && PEF.filterP3) {
                        // P1 和 P3 被選中，篩選 p1 > 0 或 p3 > 0 的數據
                        if (d.p1 > 0 || d.p3 > 0) {
                            filteredDataList.push(d); 
                        }
                    } else if (!PEF.filterP1 && PEF.filterP2 && PEF.filterP3) {
                        // P2 和 P3 被選中，篩選 p2 > 0 或 p3 > 0 的數據
                        if (d.p2 > 0 || d.p3 > 0) {
                            filteredDataList.push(d); 
                        }
                    } else if (PEF.filterP1 && PEF.filterP2 && PEF.filterP3) {
                        // P1、P2、P3 全部被選中，篩選 p1 > 0 或 p2 > 0 或 p3 > 0 的數據
                        if (d.p1 > 0 || d.p2 > 0 || d.p3 > 0) {
                            filteredDataList.push(d); 
                        }
                    } else if(!PEF.filterP1 && !PEF.filterP2 && !PEF.filterP3){
                        // 如果沒有選中任何篩選條件，保留所有數據
                        filteredDataList.push(d); 
                    }
                }
                
                fetchdata_json = filteredDataList; ; 
                _pr = el.red_pt;
                _po = el.orange_pt;
                _py = el.yellow_pt;
                _pg = el.green_pt;
                var feed = {name: course_name + course_code, data: fetchdata_json, color: el.data_list.color};
                pe_series.push(feed);
                //console.log(pe_series);
                document.getElementById('label_course_name').textContent = "課程名稱:  " + course_name;                
                document.getElementById('label_course_class').textContent = "開課系級:  " + course_code.substring(4,9) + " " + course_code.substring(9,10) + "年級 " + "學期序: " + course_code.substring(0,4) + " 班別: " + course_code.substring(17,18) + "  學生人數:" + fetchdata_json.length;
                //document.getElementById('label_course_enrolled').textContent = ;
            
                draw_piechart(_pr, _po, _py, _pg);
            }
            
            //$('#week_next').prop("disabled", false);
            //$('#week_last').prop("disabled", false);     
        } 
        
        Highcharts.chart('container-pe-course', {
            chart: {
                type: 'scatter',
                zoomType: 'xy'
            },
            title: {
                text: ''
            },
            xAxis: {
                title: {
                    enabled: true,
                    text: 'Performance'
                },
                max: 1,
                min: 0,
                plotLines: [{
                    color: 'black',
                    dashStyle: 'dot',
                    width: 2,
                    value: p_thres,
                    zIndex: 10
                }],
                plotBands: [{
                    from: 0,
                    to: p_thres-0.1
                },{
                    from: p_thres-0.1,
                    to: p_thres+0.1
                },{
                    from: p_thres+0.1,
                    to: 1
                }                
                ],
                gridLineColor: 'transparent'
            },
            yAxis: {
                title: {
                    text: 'Engagement'
                },
                max: 1,
                min: 0,
                plotLines: [{
                    color: 'black',
                    dashStyle: 'dot',
                    width: 2,
                    value: e_thres,
                    zIndex: 10
                }],
                gridLineColor: 'transparent'
            },
            legend: {
                layout: 'vertical',
                align: 'left',
                verticalAlign: 'top',
                x: 100,
                y: 70,
                floating: true,
                backgroundColor: Highcharts.defaultOptions.chart.backgroundColor,
                borderWidth: 1,
                enabled: false
            },
            plotOptions: {
                scatter: {
                    allowPointSelect: true,
                    marker: {
                        radius: 5,
                        states: {
                            hover: {
                                enabled: true,
                                lineColor: 'rgb(100,100,100)'
                            }
                        }
                    },
                    states: {
                        hover: {
                            marker: {
                                enabled: false
                            }
                        }
                    },
                    tooltip: {
                        pointFormat: '{point.name} {point.user_code} -> P: {point.x} , E: {point.y} '
                    },
                    point: {
                        events: {
                            click: function() {
                                //alert(this.color);    
                                //send query to API, retrieved students' pe info.
                                if ($.active >0) {
                                    alert('尚有未處理完的資料請求，請稍候。3');
                                    return;
                                }
                                else {
                                    $("#ddlStudents").val(this.user_code).prop('selected', true);
                                    draw_student_pe( course_id, this.user_code, this.name);
                                }
                            }
                        }
                    }
                }
            },        
            series: pe_series,
            exporting :{
                filename :'t_course_pe_'+ _week +'_chart'
            }
        });  
        
        setTimeout( function() { onSelect_student(); }, 300);
    });
}

function draw_piechart(_sr, _so, _sy, _sg){

    //alert(_sr);
    //alert(_sy);
    //alert(_sg);
    
    //colors: red orange yellow green
    var colors = ['#E60965','#FD8C04', '#FADB14', '#9FE6A0'];

    Highcharts.chart('divSemiCirclePieChart', {
        chart: {
            plotBackgroundColor: null,
            plotBorderWidth: 0,
            plotShadow: false
        },
        title: {
            text: '各區人數及比例',
            align: 'center',
            verticalAlign: 'middle',
            y: 60
        },
        tooltip: {
            pointFormat: '人數: {point.y} <b>比例:{point.percentage:.1f}%</b>'
        },
        accessibility: {
            point: {
                valueSuffix: '%'
            }
        },
        plotOptions: {
            pie: {
                dataLabels: {
                    enabled: true,
                    distance: -50,
                    style: {
                        fontWeight: 'bold',
                        color: 'white'
                    }
                },
                startAngle: -90,
                endAngle: 90,
                center: ['50%', '75%'],
                size: '110%'
            }
        },
        series: [{
            type: 'pie',
            name: '人數',
            innerSize: '50%',
            data: [{
                name : '紅區' + _sr + " 人",
                y : _sr,
                color: colors[0]
            },
            {
                name : '橘區' + _so + " 人",
                y : _so,
                color: colors[1]            
            },
            {
                name : '黃區' + _sy + " 人",
                y : _sy,
                color: colors[2]            
            },
            {
                name : '綠區:' + _sg + " 人",
                y : _sg,
                color: colors[3]    
            }]
        }],
        exporting :{
            filename :'t_pie_chart'
        }
    });
}

//teacher view the particular student's performance and engagement
function draw_student_pe(course_id, student_id, student_name){

    if ($.active >0) {
        alert('尚有未處理完的資料請求，請稍候。1');
        return;
    }
    
    _url = __local_API_ADDR + "get_individual_student_data?course_id="+window.course_id+"&student_id="+student_id;
    //alert(_url);
    
    $.ajax({    
        url: _url,
        type: "GET"
    }).success( function(getData) {    
    
        $(".highcharts-description").css('font-weight', 'bold');
        $(".highcharts-description").css('color', 'blue');    
        data_list = JSON.parse(getData);
        
        series_p = [];
        series_e = [];
        
        if (window.semester==_semester){
            _categories= _currentCategories;
            _week = _currentWeek;
            
        }else{
            _categories= [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18];
            _week =18;
        } 

       
        for (let el of data_list) {
        
            if (el.week<=_week) {
                p = parseFloat(el.p);
                e = parseFloat(el.e);
                //alert(p);
                series_p.push(p);
                series_e.push(e);
            }
        }
        
        Highcharts.chart('container-pe-student', {
            title: {
                text: student_id + " " + student_name + '同學的表現'
            },
            subtitle: {
                text: ''
            },
            xAxis: {
                title: {
                    enabled: true,
                    text: 'Weeks'
                },
                categories: _categories
            },
            yAxis: {
                title: {
                    enabled: true,
                    text: 'Values'
                },
                max: 1.0,
                min: 0.0,
                plotBands: [{
                    from: 0,
                    to: p_thres-0.1
                },{
                    from: p_thres-0.1,
                    to: p_thres+0.1
                },{
                    from: p_thres+0.1,
                    to: 1
                }                
                ],
                plotLines: [{
                    color: 'red',
                    dashStyle: 'dot',
                    width: 2,
                    value: e_thres,
                    zIndex: 10
                }],
            },
            legand: {
                layout: 'vertical',
                align: 'right',
                verticalAlign: 'middle'
            },
            series: [{
                name: 'performance',
                data: series_p
            },{
                name: 'engagement',
                data: series_e               
            }],
            exporting :{
                filename :'t_stu_line_chart'
            }
        });
    });
}

function redraw_scatterplot(course_id, semester, traverseWeek) {

    var fetchdata_json = new Array();
    
    window.course_id = course_id;
    window.semester = semester;
    
    $.ajax({    
        url: __local_API_ADDR + "get_pe_data?course_id="+course_id+"&week="+traverseWeek,
        type: "GET"
    }).success( function(getData) {
        course_name = '';
        week_list = JSON.parse(getData);
        
        var sr=sy=sg=0.0;
        //_pr= _py = _pg =0
        
        document.getElementById('label_student_list_I').textContent = ""; 
        document.getElementById('label_student_list_II').textContent = ""; 
        document.getElementById('label_student_list_III').textContent = ""; 
        document.getElementById('label_student_list_IV').textContent = "";        
        
        $("#ddlStudents").empty();
        
        for (let el of week_list) {
            week = el.week;
            course_name = el.course_name;
            course_code = el.course_code;
            
            caption_text = ""

            if (week==traverseWeek) {
                pe_series = [];                                
                
                for(d of el.data_list) {
                    d.color = scatter_color[d.color_type];
                    
                    $("#ddlStudents").append('<option value="' + d.user_code + '">' + d.name + '</option>') 
                    
                    // Quadrant I, GREEN
                    if (d.x >=0.6 & d.y >=0.6){
                        if (d.x >=0.95 & d.y >=0.95){
                            textArea_1 = document.getElementById('label_student_list_I');
                            document.getElementById('label_student_list_I').textContent += "  " + d.name;
                            d.color = '#0040FF';
                        }
                        else {
                            d.color = '#9FE6A0';
                        }
                    }
                    // Quadrant II, ORANGE
                    else if (d.x <0.6 & d.y >=0.6){
                        textArea_2 = document.getElementById('label_student_list_II');
                        document.getElementById('label_student_list_II').textContent += "  " + d.name;
                        d.color = '#FD8C04';
                    }
                    // Quadrant III, RED
                    else if (d.x <0.6 & d.y <0.6){
                        textArea_3 = document.getElementById('label_student_list_III');
                        document.getElementById('label_student_list_III').textContent += "  " + d.name;             
                        d.color = '#E60965';
                    }
                    // Quadrant IV, YELLOW
                    else {
                        textArea_4 = document.getElementById('label_student_list_IV');
                        document.getElementById('label_student_list_IV').textContent += "  " + d.name;    
                        d.color = '#FFFF37';
                    }
                }
                
                fetchdata_json = el.data_list; 
                _pr = el.red_pt;
                _py = el.yellow_pt;
                _pg = el.green_pt;
                
                var feed = {name: course_name + course_code, data: fetchdata_json, color: el.data_list.color};
                pe_series.push(feed);
                
                document.getElementById('label_course_name').textContent = "課程名稱:  " + course_name;                
                document.getElementById('label_course_class').textContent = "開課系級:  " + course_code.substring(4,9) + " " + course_code.substring(9,10) + "年級 " + "學期序: " + course_code.substring(16,17) + " 班別: " + course_code.substring(17,18) + "  學生人數:" + fetchdata_json.length;
                
                //$(".class-description").text(caption_text);
                //$(".class-description").css('font-weight', 'bold');
                //$(".class-description").css('color', 'blue');            
                
                sr = (_pr/(_pr+_pg+_py) *100).toFixed(2);
                sy = (_py/(_pr+_pg+_py) *100).toFixed(2);
                sg = (_pg/(_pr+_pg+_py) *100).toFixed(2);
                
                //$(".class-red").text("第III象限(左下紅點區)人數: " + _pr + " 人," + sr + "%");
                //$(".class-yellow").text("第II、IV象限(左上、右下黃點區)人數: " + _py + " 人," + sy + "%");
                //$(".class-green").text("第I象限(右上綠點區)人數: " + _pg + " 人," + sg + "%");  
                draw_piechart(_pr, _py, _pg);
            }
            
            //$('#week_next').prop("disabled", false);
            //$('#week_last').prop("disabled", false);     
        } 
        
        Highcharts.chart({
            chart: {
                renderTo: 'container-pe-course',
                type: 'scatter',
                zoomType: 'xy'
            },
            title: {
                text: ''
            },
            xAxis: {
                title: {
                    enabled: true,
                    text: 'Performance'
                },
                max: 1,
                min: 0,
                plotLines: [{
                    color: 'black',
                    dashStyle: 'dot',
                    width: 2,
                    value: p_thres,
                    zIndex: 10
                }],
                plotBands: [{
                    from: 0,
                    to: p_thres-0.1
                },{
                    from: p_thres-0.1,
                    to: p_thres+0.1
                },{
                    from: p_thres+0.1,
                    to: 1
                }                
                ],
                gridLineColor: 'transparent'
            },
            yAxis: {
                title: {
                    text: 'Engagement'
                },
                max: 1,
                min: 0,
                plotLines: [{
                    color: 'black',
                    dashStyle: 'dot',
                    width: 2,
                    value: e_thres,
                    zIndex: 10
                }],
                gridLineColor: 'transparent'
            },
            legend: {
                layout: 'vertical',
                align: 'left',
                verticalAlign: 'top',
                x: 100,
                y: 70,
                floating: true,
                backgroundColor: Highcharts.defaultOptions.chart.backgroundColor,
                borderWidth: 1,
                enabled: false
            },
            plotOptions: {
                scatter: {
                    allowPointSelect: true,
                    marker: {
                        radius: 5,
                        states: {
                            hover: {
                                enabled: true,
                                lineColor: 'rgb(100,100,100)'
                            }
                        }
                    },
                    states: {
                        hover: {
                            marker: {
                                enabled: false
                            }
                        }
                    },
                    tooltip: {
                        pointFormat: '{point.name} {point.user_code} -> P: {point.x} , E: {point.y} '
                    },
                    point: {
                        events: {
                            click: function() {
                                //alert(this.color);    
                                //send query to API, retrieved students' pe info.
                                if ($.active >0) {
                                    alert('尚有未處理完的資料請求，請稍候。2');
                                    return;
                                }
                                else {
                                    $("#ddlStudents").val(this.user_code).prop('selected', true);
                                    draw_student_pe( course_id, this.user_code, this.name);
                                }
                            }
                        }
                    }
                }
            },        
            series: pe_series,
            exporting: {
                filename: 't_course_pe_'+ traverseWeek +'_chart'
            }
        });
    });
}
let firstCheck = 0;

function storge_course_id(){
    //alert(course_id);
    localStorage.setItem("course_id", course_id);
    localStorage.setItem("semester", semester);
}

function turnpage(){
    tswitch = document.getElementById("myTeacherswitch");

    if(tswitch.checked == false){ 
        document.getElementById("sideblock_1").style.visibility="hidden";
        document.getElementById("sideblock_2").style.visibility="hidden";
        document.getElementById("infoblock_1").style.display="none";
        document.getElementById("infoblock_2").style.display="";
    }else{
        document.getElementById("sideblock_1").style.visibility="visible";
        document.getElementById("sideblock_2").style.visibility="visible";
        document.getElementById("infoblock_1").style.display="";
        document.getElementById("infoblock_2").style.display="none";
    }
    input_studentData();
    
}
function input_studentData(){// stu_no, stu_name, stu_idenlity, stu_proformence, stu_email
        
    url_text = __local_API_ADDR + "get_student_list?teacher_id="+t_id;

    if(firstCheck == 0){

        $.ajax({
            url: url_text,
            type: "GET"
        }).error( function(request, error) {
            alert("Error course is NULL: "+ t_id +request.responseText+" has no student");    
        }).success( function(getStuData) {
    
            if (getStuData == JSON.stringify({})) {
                alert("您這學期並未擔任任何班級的導師");
                $body.removeClass("loading");
                return;
            }
            
            stu_list = JSON.parse(getStuData);
            
            //alert(stu_list);
            
            var table = $('#tbl_course_list');
            table.empty();

            
            if (stu_list.length!=0){
                
                var row = '<tr>' + 
                    '<th>學生學號</th>'+
                    '<th>學生姓名<input type="text" id="name-search" placeholder="搜索學生姓名..."></th>'+
                    '<th>學生身份'+
                        '<select id="identity-filter">'+
                            '<option value="">所有</option>'+
                            '<option value="申請">申請生</option>'+
                            '<option value="推甄">推甄生</option>'+
                            '<option value="轉學">轉學生</option>'+
                            '<option value="僑生">僑生</option>'+
                        '</select>'+
                    '</th>'+
                    '<th title="帶改">學習表現'+
                        '<select id="performance-filter">'+
                            '<option value="default">預設</option>'+
                            '<option value="green">綠區</option>'+
                            '<option value="yellow">黃區</option>'+
                            '<option value="orange">橘區</option>'+
                            '<option value="red">紅區</option>'+
                        '</select>'+
                    '</th>'+
                '</tr>';
    
                table.append(row);

                src_g = '<img src="static/img/green.png" width="16" height="16">';
                src_y = '<img src="static/img/yellow.png" width="16" height="16">';
                src_o = '<img src="static/img/orange.png" width="16" height="16">';
                src_r = '<img src="static/img/red.png" width="16" height="16">';
                
                for (let cl of stu_list) {
                    let stu_no = cl.stu_no;
                    let stu_name = cl.stu_name;
                    let gp = cl.g_num;
                    let yp = cl.y_num;
                    let op = cl.o_num;
                    let rp = cl.r_num;
                    let p1_num = cl.p1_num; // 取得 p1 數據
                    let p2_num = cl.p2_num; // 取得 p2 數據
                    let p3_num = cl.p3_num; // 取得 p3 數據

                    _link = '<a href="javascript:stupage(\'' + stu_no + '\', \'' + stu_name + '\')" title="點擊查看學生詳情">' + stu_no + "</a>";

                    var identity = cl.stu_Identity ? cl.stu_Identity : '';

                    // 如果 p1_num > 0，則加上淡紅色背景和邊框
                    var rowStyle = '';
                    if (p1_num > 0) {
                        rowStyle = ' style="background-color: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.3);"';
                    }

                    var row = '<tr' + rowStyle + ' cellpadding="15px">' + 
                        '<th>'+_link+'</th>' +
                        '<th>'+stu_name+'</th>' +
                        '<th>'+identity+'</th>' +
                        '<th data-green="' + gp + '" data-yellow="' + yp + '" data-orange="' + op + '" data-red="' + rp + '">' +
                            src_g + gp + "  " + src_y + yp + "  " + src_o + op + "  " + src_r + rp +
                        '</th>' +
                        '<th style="display:none;">' + p1_num + '</th>' + // 隱藏的 p1 數據
                        '<th style="display:none;">' + p2_num + '</th>' + // 隱藏的 p2 數據
                        '<th style="display:none;">' + p3_num + '</th>' + // 隱藏的 p3 數據
                    '</tr>';

                    table.append(row);
                }
            }
        })

        //student search's function
        $(document).on('input change', '#name-search, #identity-filter, #attendance-filter, #performance-filter', function() {
            filterTable();
        });
    }

    firstCheck = 1;
}

function stupage(account,stu_name){
    document.getElementById("info-display").textContent = 
    "已選擇學生:"  +stu_name+ " 學號:" + account;
    localStorage.setItem("student_id", account);
    input_studentId();
}

function input_studentId(){//and student name
    //var account = '{{account}}';
    //s_id = window.localStorage.getItem("student_id") || account;
    s_id = window.localStorage.getItem("student_id");
    //alert(s_id)
    
    __1st_course_id='';
    
    $.ajax({
        url: __local_API_ADDR + "get_student_name?student_id=" + s_id,
        type: 'GET',
        success: function(response) {
            // 假設 API 返回的 response 是學生姓名
            var studentName = response.student_name ; // 確保有個默認值以防API出錯
            // 將學生姓名設置到 dynamicCourseName span
            $('#dynamicStudnetName').text(studentName);
            $('#dynamicStudnetName1').text(studentName);
            $('#dynamicStudnetName2').text(studentName);
            $('#dynamicStudnetNumber').text(s_id);
            $('#dynamicStudnetNumber1').text(s_id);
            $('#dynamicStudnetNumber2').text(s_id);


        },
        error: function(xhr, status, error) {
            console.error("API 調用失敗: " + error);
            // 如果出錯，設置一個默認值
            $('#dynamicCourseName').text("姓名載入失敗");
        }
    });
    
    url_text = __local_API_ADDR + "get_course_list_detail?id="+s_id;
    //url_text = __local_API_ADDR.replace(/^http:/, 'https:') + "get_course_list_detail?id="+s_id;
    //alert(url_text)
    
    this.user_code = s_id;
    
    $.ajax({
        url: url_text,
        type: "GET"
    }).error( function(request, error) {
        alert("Error course is NULL: "+ s_id +request.responseText+" has no course");    
    }).success( function(getCourseData) {
    

    
        if (getCourseData == JSON.stringify({})) {
            alert("並無任何與參與度或活動成績有關之iClass課程紀錄！");
            $body.removeClass("loading");
            //location.href = "index";
            pageback();
            return;
        }
        
        course_list = JSON.parse(getCourseData);
        //alert(course_list);
        
        var table = $('#tbl_student_course_list');
        table.empty(); 
        
        _r=0;
        _y=0;
        _g=0;
        _b=0;
        
        if (course_list.length!=0){
        
            __1st_course_id = course_list[0].course_id;
    
            var container_1 = $('#divCourseContainer_current');
            container_1.empty();      
            
            var row = '<tr>' + 
                '<th>課程代碼</th>' +
                '<th>課程名稱</th>' +
                '<th>警示燈號</th>' +
                '<th>學習表現</th>' +
                '<th>參與度</th>' +
            '</tr>';
            
            table.append(row);
            
            // set id as course_code
            for (let cl of course_list) {
                let course_code = cl.code;
                let course_name = cl.name;
                let _weeks = cl.weeks;            
                let _p = cl.p;            
                let _e = cl.e;            
                let color = cl.color;     
                let course_id = cl.course_id;   
                let p1_num = cl.p1; // 取得 p1 數據

                /*
                if (_p==0){
                   if (_e==0){
                       continue;
                   }
                }*/
                
                var br = document.createElement('br');
    
                var a = document.createElement('a');
                var linkText = document.createTextNode(course_name + course_code );
                a.appendChild(linkText);
                a.title = course_name + course_code ;
                a.href="javascript:redraw_student_chart(" + course_code.substring(11) + ","+_semester+")";
                
                container_1.append(a);                
                container_1.append(br);       
                
                if (color=='b') {
                    _g +=1;
                    src = '<img src="static/img/blue.png" width="16" height="16">'
                }
                else if (color=='g') {
                    _g +=1;
                    src = '<img src="../6869/static/img/green.png" width="16" height="16">'
                }
                else if (color=='y') {
                    _y +=1;
                    src = '<img src="../6869/static/img/yellow.png" width="16" height="16">'
                }
                else {
                    _r +=1; 
                    src = '<img src="../6869/static/img/red.png" width="16" height="16">'
                }
                
                _link = '<a href="javascript:redraw_student_chart(' +course_id + ','+_semester+')' + '">' + course_code + "</a>"
                var rowStyle = '';

                if (p1_num > 0) {
                    rowStyle = ' style="background-color: rgba(255, 0, 0, 0.1); border: 1px solid rgba(255, 0, 0, 0.3);"';
                }
                var row = '<tr' + rowStyle + ' cellpadding="15px">' + 
                    '<th>'+_link+'</th>' +
                    '<th>'+course_name+'</th>' +
                    '<th>'+src+'</th>' +
                    '<th>'+roundDown(_p, 2)+'</th>' +
                    '<th>'+roundDown(_e, 2)+'</th>' +
                '</tr>';
                
                table.append(row);
            }                 
            
            draw_student_piechart(_r, _y, _g);

            if (__1st_course_id.length!=0){
                
                setTimeout( function() { redraw_student_chart(__1st_course_id, _semester); }, 300);
            }
        }
    });
}

roundDown = function( num, decimal ) { 
    return Math.floor( ( num + Number.EPSILON ) * Math.pow( 10, decimal ) ) / Math.pow( 10, decimal );
}

function draw_student_piechart(_sr, _sy, _sg){

//alert(_sr);
//alert(_sy);
//alert(_sg);

var colors = ['#E60965', '#FD8C04', '#9FE6A0' ];

Highcharts.chart('divSemiCirclePieChart-student', {
    chart: {
        plotBackgroundColor: null,
        plotBorderWidth: 0,
        plotShadow: false
    },
    title: {
        text: '課程數及比例',
        align: 'center',
        verticalAlign: 'middle',
        y: 60
    },
    tooltip: {
        pointFormat: '課程數: {point.y} <b>比例:{point.percentage:.1f}%</b>'
    },
    accessibility: {
        point: {
            valueSuffix: '%'
        }
    },
    plotOptions: {
        pie: {
            dataLabels: {
                enabled: true,
                distance: -50,
                style: {
                    fontWeight: 'bold',
                    color: 'white'
                }
            },
            startAngle: -90,
            endAngle: 90,
            center: ['50%', '75%'],
            size: '110%'
        }
    },
    series: [{
        type: 'pie',
        name: '課程數',
        innerSize: '50%',
        data: [{
            name : '紅區' + _sr + " 門",
            y : _sr,
            color: colors[0]
        },
        {
            name : '黃區' + _sy + " 門",
            y : _sy,
            color: colors[1]            
        },
        {
            name : '綠區:' + _sg + " 門",
            y : _sg,
            color: colors[2]    
        }]
    }],
    exporting :{
        filename :'stu_pie_chart'
    }
});
}
function redraw_student_chart(course_id, semester) {

//alert(this.user_code);

var fetchdata_json = new Array();

window.course_id = course_id;
window.semester = semester;

_s_id = this.user_code;

if (semester==_semester) {
    _week=_currentWeek;
}
else {
    _week=18;
}

$.ajax({            
    url: __local_API_ADDR + "get_pe_data?course_id="+course_id+"&week="+_week,
    //url:  __local_API_ADDR.replace(/^http:/, 'https:') + "get_pe_data?course_id="+course_id+"&week="+_week,
    type: "GET"
}).success( function(getData) {
    course_name = '';
    week_list = JSON.parse(getData);
    
    if (JSON.stringify(week_list) == '{}'){
        alert('您點選的這門課程沒有資料')
        return;
    }
    
    for (let el of week_list) {
        week = el.week;
        course_name = el.course_name;
        course_code = el.course_code;
        //console.log(el.data_list);
        
        window.course_name = course_name;
        
        caption_text = ""

        if (week==_week) {
            pe_series = [];
            sid_datalist = [];
            
            for(let d of el.data_list) {
                if (d.user_code==_s_id){
                    d.color = '#EA0000';
                    sid_datalist.push(d);
                }
                else {
                    d.color = '#FFD306';
                }   
            }
            fetchdata_json = el.data_list;                 
            var feed = {name: course_name + course_code, data: fetchdata_json};
            var feed2 = {name: course_name + course_code, data :sid_datalist, zIndex: 99};
            pe_series.push(feed);
            pe_series.push(feed2);
            //console.log(pe_series);
        }
    } 
    
    Highcharts.chart('container-pe-course-student', {
        chart: {
            type: 'scatter',
            zoomType: 'xy'
        },
        title: {
            text: course_name
        },
        xAxis: {
            title: {
                enabled: true,
                text: 'Performance'
            },
            max: 1,
            min: 0,
            plotLines: [{
                color: 'black',
                dashStyle: 'dot',
                width: 2,
                value: p_thres,
                zIndex: 10
            }],
            plotBands: [{
                from: 0,
                to: p_thres-0.1
            },{
                from: p_thres-0.1,
                to: p_thres+0.1
            },{
                from: p_thres+0.1,
                to: 1
            }                
            ],
            gridLineColor: 'transparent'
        },
        yAxis: {
            title: {
                text: 'Engagement'
            },
            max: 1,
            min: 0,
            plotLines: [{
                color: 'black',
                dashStyle: 'dot',
                width: 2,
                value: e_thres,
                zIndex: 10
            }],
            gridLineColor: 'transparent'
        },
        legend: {
            layout: 'vertical',
            align: 'left',
            verticalAlign: 'top',
            x: 100,
            y: 70,
            floating: true,
            backgroundColor: Highcharts.defaultOptions.chart.backgroundColor,
            borderWidth: 1,
            enabled: false
        },
        plotOptions: {
            scatter: {
                allowPointSelect: true,
                marker: {
                    radius: 5,
                    states: {
                        hover: {
                            enabled: true,
                            lineColor: 'rgb(100,100,100)'
                        }
                    }
                },
                states: {
                    hover: {
                        marker: {
                            enabled: false
                        }
                    }
                },
                tooltip: {
                    pointFormat: '-> P: {point.x} , E: {point.y} ' //'{point.user_code} -> P: {point.x} , E: {point.y} '
                },
            }
        },        
        series: pe_series,
        exporting :{
            filename :'stu_point_chart'
        }
    });  
    
    setTimeout( function() { draw_avg_pe(course_id)}, 300);
});
}
function draw_avg_pe(course_id){

if ($.active >0) {
    alert('尚有未處理完的資料請求(AVG)，請稍候。');
    return;
}

s_id = this.user_code;

_url = __local_API_ADDR + "get_avg_pe?course_id="+course_id+"&student_id="+s_id+"&semester="+semester;
//alert(_url);

//alert(semester);

$.ajax({
    url: _url,
    type: "GET"
}).success( function(getData) {
    //alert("ajax succes");
    //alert(getdata);
    
    data_list = JSON.parse(getData);
    //alert(data_list);
    
    series_p = [];
    series_e = [];
    avg_p = [];
    avg_e = [];

    _categories = []

    if (window.semester=='1121'){
        _categories= _currentCategories;
        _week = _currentWeek;
        
    }else{
        _categories= [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18];
        _week =18;
    }
    
    for (let el of data_list) {
        if (el.weeks<=_week) {
            avgp = parseFloat(el.avg_p);
            avge = parseFloat(el.avg_e);
            p = parseFloat(el.p);
            e = parseFloat(el.e);
            //alert(p);
            avg_p.push(avgp);
            avg_e.push(avge);
            series_p.push(p);
            series_e.push(e);
        }
    }
            
    Highcharts.chart('container-pe-avg', {
      chart: {
        zoomType: 'xy'
      },
      title: {
        text: window.course_name
      },
      xAxis: {
        categories: _categories,
        crosshair: true,
        title: {
          text: 'Weeks'
        }
      },
      yAxis:{
        min: 0,
        max: 1,
        title: {
          text: 'Engagement and Performance'
        }
      },
      tooltip: {
        headerFormat: '<span style="font-size:14px">week:{point.key}</span><table>',
        pointFormat: '<tr><td style="color:{series.color};padding:0">{series.name}: </td>' +
          '<td style="padding:0"><b>{point.y:.2f} </b></td></tr>',
        footerFormat: '</table>',
        shared: true,
        useHTML: true
      },
      plotOptions: {
        column: {
          pointPadding: 0.2,
          borderWidth: 0
        },
      },
      series: [{
        name: '班平均-P',
        data: avg_p,
        type: 'column'
      }, {
        name: '班平均-E',
        data: avg_e,
        type: 'column',
        color: "gray"
      },{
        name: '個人-P',
        data: series_p,
        color: "orange"
      },{
        name: '個人-E',
        data: series_e,
        color: "lime"
      }],
      exporting: {
        filename: 'stu_semester_avg_chart'
      }
    });
})
}

document.querySelectorAll('.tab-link').forEach(tab => {
    tab.addEventListener('click', function(event) {
        event.preventDefault(); // Prevent default anchor click behavior
        
        // Remove active class from all tabs
        document.querySelectorAll('.tabs_pe li').forEach(li => li.classList.remove('active'));
        
        // Hide all tab content
        document.querySelectorAll('.tab-inner').forEach(tabContent => {
            tabContent.style.display = 'none';
        });

        // Add active class to the clicked tab
        this.parentElement.classList.add('active');
        
        // Show the associated tab content
        const activeTabId = this.getAttribute('href');
        document.querySelector(activeTabId).style.display = 'block';
    });
});

// ------------------------------------------------------------------

function toggleExplanation() {
    const explanationText = [];
    if (p1p2p3.p1) {
        explanationText.push('M1 表示有至少一個課程出席未到一半');
    }
    
    if (p1p2p3.p2 && p1p2p3.p1) {
        explanationText.push('M2 表示至少一個課程p跟e未到0.6');
    }
    else if (p1p2p3.p2) {
        explanationText.push('M2 表示至少一個課程p跟e未到0.6');
    }

    // 更新顯示的說明內容
    document.getElementById('explanation').innerText = explanationText.join('   ');
}

var p1p2p3 = {
    p1:false,
    p2:false,
    p3:false
};
var currentFilters = {
    class: null,
    grade: null,
    department: null
};
$(document).ready(function() {

    // 篩選 p1
    $('#filterP1').on('click', function() {
        p1p2p3.p1 = !p1p2p3.p1; // 切換 p1 篩選狀態
        filterTable(); // 重新篩選表格
        toggleExplanation(); // 更新說明
    });

    // 篩選 p2
    $('#filterP2').on('click', function() {
        p1p2p3.p2 = !p1p2p3.p2; // 切換 p2 篩選狀態
        filterTable(); // 重新篩選表格
        toggleExplanation(); // 更新說明
    });

    // 篩選 p3
    $('#filterP3').on('click', function() {
        p1p2p3.p3 = !p1p2p3.p3; // 切換 p3 篩選狀態
        filterTable(); // 重新篩選表格
    });

    $('#resetFilter').on('click', function() {
        $('#tbl_course_list tr').show(); // 顯示所有行
    });
});

function filterTable() {
    var search = $('#name-search').val();
    var filter = $('#identity-filter').val();
    var attendanceSort = $('#attendance-filter').val();
    var performanceSort = $('#performance-filter').val();
    var found = false;

    var rows = $('#tbl_course_list tr').not(':first').detach();

    rows.sort(function(a, b) {
    // 取得每個行中對應區域的值
        var performanceA, performanceB;

        if (performanceSort === 'green') {
            performanceA = parseFloat($(a).find('th').eq(3).data('green'));
            performanceB = parseFloat($(b).find('th').eq(3).data('green'));
        } else if (performanceSort === 'yellow') {
            performanceA = parseFloat($(a).find('th').eq(3).data('yellow'));
            performanceB = parseFloat($(b).find('th').eq(3).data('yellow'));
        } else if (performanceSort === 'orange') {
            performanceA = parseFloat($(a).find('th').eq(3).data('orange'));
            performanceB = parseFloat($(b).find('th').eq(3).data('orange'));
        } else if (performanceSort === 'red') {
            performanceA = parseFloat($(a).find('th').eq(3).data('red'));
            performanceB = parseFloat($(b).find('th').eq(3).data('red'));
        } else {
            var idA = parseInt($(a).find('th').eq(0).text());
            var idB = parseInt($(b).find('th').eq(0).text());
            return idA-idB; // 如果是預設選項，不進行排序
        }
        // 確保數據都是數字型態，進行升序或降序比較
        return performanceB - performanceA;
    });

    $.each(rows, function(index, row) {
        $('#tbl_course_list').append(row);
    });

    $('#tbl_course_list tr').each(function() {
        if ($(this).find('input, select').length > 0) {
            return; // 跳過輸入和選擇行
        }

        var name = $(this).find('th').eq(1).text();
        var courseClass = $(this).find('th').eq(2).text();
        var identity = $(this).find('th').eq(2).text();
        var courseCode = $(this).find('th').eq(7).text();
        var courseGrade = $(this).find('th').eq(7).text().charAt(5); // 獲取隱藏的課程代碼列

        // 取得 p1, p2, p3 的值
        var p1Num = parseInt($(this).find('th').eq(4).text()); // 假設第 10 列是 p1_num
        var p2Num = parseInt($(this).find('th').eq(5).text()); // 假設第 11 列是 p2_num
        var p3Num = parseInt($(this).find('th').eq(6).text()); // 假設第 12 列是 p3_num
        // 根據篩選條件進行篩選
        let showRow = true;

        // P1, P2, P3 篩選邏輯
        if (p1p2p3.p1 && p1Num === 0) {
            showRow = false; // p1 需要篩選，但 p1Num 是 0
        }
        if (p1p2p3.p2 && p2Num === 0) {
            showRow = false; // p2 需要篩選，但 p2Num 是 0
        }
        if (p1p2p3.p3 && p3Num === 0) {
            showRow = false; // p3 需要篩選，但 p3Num 是 0
        }

        // 其他篩選條件
        if (name.indexOf(search) > -1 && 
            (filter === '' || identity.indexOf(filter) > -1) &&
            (currentFilters.class === null || courseClass === currentFilters.class) &&
            (currentFilters.grade === null || (currentFilters.grade && currentFilters.department.substring(0, 5) === courseCode.substring(0, 5) && courseGrade === currentFilters.grade)) &&
            (currentFilters.department === null || currentFilters.department.substring(0, 5) === courseCode.substring(0, 5))) {
            
            // 如果符合所有條件，顯示行
            if (showRow) {
                $(this).show();
                found = true; // 設置找到標記
            } else {
                $(this).hide(); // 隱藏不符合的行
            }
        } else {
            $(this).hide(); // 隱藏不符合的行
        }
    });
}


</script>
</html>